<!DOCTYPE html>
<!-- @noSnoop -->
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom History Chart</title>

    <script type='text/javascript' src='/requirejs/config.js'></script>
    <script type='text/javascript' src='/module/js/com/tridium/js/ext/require/require.min.js'></script>

    <style>
        /* CSS Variables for easy theming */
        :root {
            --bg-color: linear-gradient(to right, #eef2f3, #f4f4f4);
            --text-color: #333;
            --header-color: #0056b3;
            --card-bg-color: #ffffff;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --toggle-bg: #e9e9e9;
            --toggle-fg: #f4f4f4;
            --toggle-icon-color: #2c3e50;
            /* Chart Specific Colors */
            --chart-grid-color: 'rgba(0, 0, 0, 0.1)';
            --chart-font-color: '#666';
            --chart-line-color: 'rgba(0, 123, 255, 1)';
            --chart-fill-color: 'rgba(0, 123, 255, 0.2)';
        }

        body.dark-mode {
            --bg-color: linear-gradient(to right, #2c3e50, #4ca1af);
            --text-color: #f4f4f4;
            --header-color: #76c7ff;
            --card-bg-color: #2c3e50;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.3);
            --toggle-bg: #76c7ff;
            --toggle-fg: #2c3e50;
            --toggle-icon-color: #f4f4f4;
            /* Chart Specific Dark Colors */
            --chart-grid-color: 'rgba(255, 255, 255, 0.2)';
            --chart-font-color: '#ccc';
            --chart-line-color: 'rgba(118, 200, 255, 1)';
            --chart-fill-color: 'rgba(118, 200, 255, 0.2)';
        }

        body {
            font-family: Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        h1 {
            text-align: center;
            color: var(--header-color);
            margin-bottom: 20px;
        }

        .chart-container {
            max-width: 1000px;
            margin: auto;
            background: var(--card-bg-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            transition: background-color 0.3s ease;
        }

        .chart-wrapper {
            position: relative;
            height: 60vh;
            width: 100%;
        }
        
        /* --- Theme Toggle Switch Styles --- */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin: 0 auto 20px;
            max-width: 1000px; /* Aligns with the chart container */
        }
        .theme-switch {
            display: inline-block;
            height: 34px;
            position: relative;
            width: 60px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: var(--toggle-bg);
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            background-color: var(--toggle-fg);
            bottom: 4px;
            content: "";
            height: 26px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 26px;
            border-radius: 50%;
            content: '‚òÄÔ∏è';
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--toggle-icon-color);
        }
        input:checked + .slider {
            background-color: var(--toggle-bg);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
            content: 'üåô';
        }

    </style>
</head>
<body>

    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
            <div class="slider round"></div>
        </label>
    </div>

    <div class="chart-container">
        <h1>Space Temperature History (Last Hour)</h1>
        <div class="chart-wrapper">
            <canvas id="history-chart"></canvas>
        </div>
    </div>

<script>
    // We tell require.js about our custom libraries.
    require.config({
        paths: {
            'chartjs': '/file/jsFiles/Chart.min',
            'dayjs': '/file/jsFiles/dayjs.min'
        }
    });

    // We ask require.js to load our needed libraries.
    require(['baja!', 'chartjs', 'dayjs'], function (baja, Chart, dayjs) {
        'use strict';

        const canvas = document.getElementById('history-chart');
        let myChart = null;

        /**
         * Returns the Chart.js options object, styled for the current theme.
         */
        function getChartOptions() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
            const fontColor = isDarkMode ? '#ccc' : '#666';

            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'Time', color: fontColor },
                        ticks: { color: fontColor },
                        grid: { color: gridColor }
                    },
                    y: {
                        title: { display: true, text: 'Temperature (¬∞F)', color: fontColor },
                        ticks: { color: fontColor },
                        grid: { color: gridColor }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: fontColor
                        }
                    }
                }
            };
        }

        /**
         * Returns the Chart.js dataset object, styled for the current theme.
         */
        function getChartDataset(data) {
             const isDarkMode = document.body.classList.contains('dark-mode');
             const lineColor = isDarkMode ? 'rgba(118, 200, 255, 1)' : 'rgba(0, 123, 255, 1)';
             const fillColor = isDarkMode ? 'rgba(118, 200, 255, 0.2)' : 'rgba(0, 123, 255, 0.2)';

            return [{
                label: 'Space Temperature',
                data: data,
                borderColor: lineColor,
                backgroundColor: fillColor,
                fill: true,
                tension: 0.1
            }];
        }

        /**
         * Fetches history data using BQL and renders the chart.
         */
        function loadAndRenderChart() {
            const timestamps = [];
            const values = [];

            const lastHour = dayjs().subtract(1, 'hour').toISOString();
            const historyName = 'DemoJace9000/AHU_SpaceTemp';
            const historyOrd = baja.Ord.make(`history:/${historyName}|bql:select timestamp, value where timestamp >= '${lastHour}'`);
            
            console.log("Fetching data with BQL ORD: " + historyOrd.toString());

            historyOrd.get({
                cursor: {
                    limit: 1000,
                    each: function (row) {
                        const rawTimestamp = row.get("timestamp");
                        timestamps.push(dayjs(rawTimestamp).format("h:mm A"));
                        values.push(row.get("value"));
                    }
                }
            })
            .then(function () {
                console.log(`Successfully fetched ${values.length} records.`);
                renderChart(timestamps, values);
            })
            .catch(function (err) {
                console.error('Error loading history data:', err);
                alert('Failed to load history data. Check console (F12) for details.');
            });
        }

        /**
         * Renders the chart on the canvas using the provided data.
         */
        function renderChart(labels, data) {
            if (myChart) {
                myChart.destroy();
            }

            const ctx = canvas.getContext('2d');
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: getChartDataset(data)
                },
                options: getChartOptions()
            });
        }
        
        // --- Theme Toggle Logic ---
        const toggle = document.getElementById('checkbox');

        function applyTheme(theme) {
            if (theme === 'dark-mode') {
                document.body.classList.add('dark-mode');
                toggle.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                toggle.checked = false;
            }
            // If the chart exists, update its options and re-render
            if (myChart) {
                myChart.options = getChartOptions();
                myChart.data.datasets = getChartDataset(myChart.data.datasets[0].data); // Preserve existing data
                myChart.update();
            }
        }

        toggle.addEventListener('change', function() {
            const theme = this.checked ? 'dark-mode' : 'light-mode';
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        });

        // --- Initial Load and Auto-Refresh ---
        const savedTheme = localStorage.getItem('theme') || 'light-mode';
        applyTheme(savedTheme); // Apply theme on initial load

        loadAndRenderChart();
        setInterval(loadAndRenderChart, 300000); // Refresh data every 5 minutes
    });
</script>

</body>
</html>