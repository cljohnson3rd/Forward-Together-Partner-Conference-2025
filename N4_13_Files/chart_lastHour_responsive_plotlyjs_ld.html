<!DOCTYPE html>
<!-- @noSnoop -->
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom History Chart - Plotly.js</title>

    <script type='text/javascript' src='/requirejs/config.js'></script>
    <script type='text/javascript' src='/module/js/com/tridium/js/ext/require/require.min.js'></script>

    <style>
        /* CSS Variables for easy theming */
        :root {
            --bg-color: linear-gradient(to right, #eef2f3, #f4f4f4);
            --text-color: #333;
            --header-color: #0056b3;
            --card-bg-color: #ffffff;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --toggle-bg: #e9e9e9;
            --toggle-fg: #f4f4f4;
            --toggle-icon-color: #2c3e50;
        }

        body.dark-mode {
            --bg-color: linear-gradient(to right, #2c3e50, #4ca1af);
            --text-color: #f4f4f4;
            --header-color: #76c7ff;
            --card-bg-color: #2c3e50;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.3);
            --toggle-bg: #76c7ff;
            --toggle-fg: #2c3e50;
            --toggle-icon-color: #f4f4f4;
        }

        body {
            font-family: Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        h1 {
            text-align: center;
            color: var(--header-color);
            margin-bottom: 20px;
        }

        .chart-container {
            max-width: 1000px;
            margin: auto;
            background: var(--card-bg-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            transition: background-color 0.3s ease;
        }

        .chart-wrapper {
            position: relative;
            height: 60vh;
            width: 100%;
        }

        /* Plotly Chart Styles */
        #history-chart {
            width: 100%;
            height: 100%;
        }
        
        /* Theme Toggle Switch Styles */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin: 0 auto 20px;
            max-width: 1000px;
        }
        .theme-switch {
            display: inline-block;
            height: 34px;
            position: relative;
            width: 60px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: var(--toggle-bg);
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            background-color: var(--toggle-fg);
            bottom: 4px;
            content: "";
            height: 26px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 26px;
            border-radius: 50%;
            content: '‚òÄÔ∏è';
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--toggle-icon-color);
        }
        input:checked + .slider {
            background-color: var(--toggle-bg);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
            content: 'üåô';
        }

    </style>
</head>
<body>

    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
            <div class="slider round"></div>
        </label>
    </div>

    <div class="chart-container">
        <h1>Space Temperature History (Last Hour)</h1>
        <div class="chart-wrapper">
            <div id="history-chart"></div>
        </div>
    </div>

<script>
    require.config({
        paths: {
            'plotly': '/file/jsFiles/plotly.min',
            'dayjs': '/file/jsFiles/dayjs.min'
        }
    });

    require(['baja!', 'plotly', 'dayjs'], function (baja, Plotly, dayjs) {
        'use strict';

        // Test if Plotly loaded correctly
        console.log("Plotly object:", Plotly);
        console.log("Plotly version:", Plotly ? Plotly.BUILD : "Not loaded");
        
        if (!Plotly || !Plotly.newPlot) {
            console.error("Plotly.js failed to load properly!");
            document.getElementById('history-chart').innerHTML = 
                '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 16px; color: red;">Plotly.js failed to load. Check console for details.</div>';
            return;
        }

        let chartData = [];
        
        /**
         * Gets theme colors for the current mode
         */
        function getThemeColors() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            return {
                background: isDarkMode ? '#2c3e50' : '#ffffff',
                paper: isDarkMode ? '#2c3e50' : '#ffffff',
                text: isDarkMode ? '#ccc' : '#666',
                grid: isDarkMode ? '#4a4a4a' : '#e1e1e1',
                line: isDarkMode ? '#5cb85c' : '#ff6b35',  // Green for dark, orange for light
                fill: isDarkMode ? 'rgba(92, 184, 92, 0.3)' : 'rgba(255, 107, 53, 0.3)'  // Matching fills
            };
        }

        /**
         * Creates or updates the Plotly.js chart
         */
        function renderChart(timestamps, values) {
            const colors = getThemeColors();
            
            // Store data for theme switching
            chartData = {
                timestamps: timestamps,
                values: values
            };

            // Calculate Y-axis range with padding (don't start at 0)
            const minTemp = Math.min(...values);
            const maxTemp = Math.max(...values);
            const tempRange = maxTemp - minTemp;
            const padding = Math.max(tempRange * 0.1, 0.5); // At least 0.5¬∞F padding
            const yMin = minTemp - padding;
            const yMax = maxTemp + padding;

            // Create baseline trace for fill
            const baselineTrace = {
                x: timestamps,
                y: Array(timestamps.length).fill(yMin),
                type: 'scatter',
                mode: 'lines',
                line: { color: 'transparent' },
                showlegend: false,
                hoverinfo: 'skip'
            };

            // Prepare the data trace
            const trace = {
                x: timestamps,
                y: values,
                type: 'scatter',
                mode: 'lines+markers',
                fill: 'tonexty',
                fillcolor: colors.fill,
                line: {
                    color: colors.line,
                    width: 3,
                    shape: 'spline',
                    smoothing: 0.3
                },
                marker: {
                    color: colors.line,
                    size: 4
                },
                name: 'Temperature',
                hovertemplate: '%{y:.2f}¬∞F<br>%{x}<extra></extra>'
            };

            // Layout configuration
            const layout = {
                title: {
                    text: '',
                    font: { color: colors.text }
                },
                paper_bgcolor: colors.paper,
                plot_bgcolor: colors.background,
                font: {
                    family: 'Arial, sans-serif',
                    color: colors.text
                },
                xaxis: {
                    title: {
                        text: 'Time',
                        font: { color: colors.text, size: 14 }
                    },
                    tickfont: { color: colors.text, size: 11 },
                    gridcolor: colors.grid,
                    linecolor: colors.text,
                    tickangle: -35,
                    tickmode: 'auto',
                    nticks: Math.min(timestamps.length, 8)
                },
                yaxis: {
                    title: {
                        text: 'Temperature (¬∞F)',
                        font: { color: colors.text, size: 14 }
                    },
                    tickfont: { color: colors.text },
                    gridcolor: colors.grid,
                    linecolor: colors.text,
                    tickformat: '.2f',
                    range: [yMin, yMax]  // Auto-range around data, don't start at 0
                },
                margin: {
                    l: 70,
                    r: 20,
                    t: 30,
                    b: 80
                },
                showlegend: false,
                hovermode: 'x unified'
            };

            // Configuration options
            const config = {
                responsive: true,
                displayModeBar: false,
                displaylogo: false
            };

            // Create or update the plot
            Plotly.newPlot('history-chart', [baselineTrace, trace], layout, config);
        }

        /**
         * Updates chart theme colors
         */
        function updateChartTheme() {
            if (chartData.timestamps && chartData.values) {
                renderChart(chartData.timestamps, chartData.values);
            }
        }

        /**
         * Fetches history data using BQL and renders the chart
         */
        function loadAndRenderChart() {
            const timestamps = [];
            const values = [];

            const lastHour = dayjs().subtract(1, 'hour').toISOString();
            const now = dayjs().toISOString();
            const historyName = 'DemoJace9000/VAV_SpaceTemp';
            const historyOrd = baja.Ord.make(`history:/${historyName}|bql:select timestamp, value where timestamp >= '${lastHour}' and timestamp <= '${now}' order by timestamp`);
            
            console.log("Current time: " + dayjs().format("YYYY-MM-DD HH:mm:ss"));
            console.log("Query time range: " + lastHour + " to " + now);
            console.log("Fetching data with BQL ORD: " + historyOrd.toString());

            historyOrd.get({
                cursor: {
                    limit: 1000,
                    each: function (row) {
                        const rawTimestamp = row.get("timestamp");
                        const formattedTime = dayjs(rawTimestamp).format("h:mm A");
                        const value = row.get("value");
                        
                        timestamps.push(formattedTime);
                        values.push(value);
                        
                        console.log("Data point: " + formattedTime + " = " + value + "¬∞F");
                    }
                }
            })
            .then(function () {
                console.log(`Successfully fetched ${values.length} records.`);
                console.log("Timestamps: ", timestamps);
                console.log("Values: ", values);
                
                if (values.length === 0) {
                    console.warn("No data returned! Check if the history point exists and has recent data.");
                    document.getElementById('history-chart').innerHTML = 
                        '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 16px; color: var(--text-color);">No data available for the last hour</div>';
                } else {
                    renderChart(timestamps, values);
                }
            })
            .catch(function (err) {
                console.error('Error loading history data:', err);
                alert('Failed to load history data. Check console (F12) for details.');
            });
        }
        
        // Theme Toggle Logic
        const toggle = document.getElementById('checkbox');

        function applyTheme(theme) {
            if (theme === 'dark-mode') {
                document.body.classList.add('dark-mode');
                toggle.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                toggle.checked = false;
            }
            // Update chart theme
            updateChartTheme();
        }

        toggle.addEventListener('change', function() {
            const theme = this.checked ? 'dark-mode' : 'light-mode';
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (chartData.timestamps && chartData.values) {
                Plotly.Plots.resize('history-chart');
            }
        });

        // Initial Load and Auto-Refresh
        const savedTheme = localStorage.getItem('theme') || 'light-mode';
        applyTheme(savedTheme);

        loadAndRenderChart();
        setInterval(loadAndRenderChart, 300000); // Refresh every 5 minutes
    });
</script>

</body>
</html>