<!DOCTYPE html>
<!-- @noSnoop -->
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAV Gauge Dashboard</title>

    <script type='text/javascript' src='/requirejs/config.js'></script>
    <script type='text/javascript' src='/module/js/com/tridium/js/ext/require/require.min.js'></script>

    <style>
        /* CSS Variables for easy theming */
        :root {
            --bg-color: linear-gradient(to right, #eef2f3, #f4f4f4);
            --card-bg-color: #ffffff;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            --text-color: #333;
            --toggle-bg: #e9e9e9;
            --toggle-fg: #f4f4f4;
            --toggle-icon-color: #2c3e50;
            /* Gauge Specific Colors */
            --gauge-bg-arc-color: #ddd;
            --gauge-fill-color: #007bff;
            --gauge-label-color: #333; /* Dark gray for light mode */
            --gauge-value-color: #000;
        }

        body.dark-mode {
            --bg-color: linear-gradient(to right, #2c3e50, #4ca1af);
            --card-bg-color: #2c3e50;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.3);
            --text-color: #f4f4f4;
            --toggle-bg: #76c7ff;
            --toggle-fg: #2c3e50;
            --toggle-icon-color: #f4f4f4;
            /* Gauge Specific Dark Colors */
            --gauge-bg-arc-color: #4a4a4a;
            --gauge-fill-color: #76c7ff;
            --gauge-label-color: #E0E0E0; /* CHANGED: A very bright, clear light gray */
            --gauge-value-color: #ffffff;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: var(--bg-color);
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            transition: background 0.3s ease;
        }

        .container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            background: var(--card-bg-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            transition: background-color 0.3s ease;
        }
        
        .gauge-container {
            margin: 10px;
            padding: 15px;
            text-align: center;
        }

        .gauge-foreground {
            fill: var(--gauge-fill-color);
            transition: fill 0.3s ease;
        }
        
        /* --- NEW CSS CLASS FOR THE GAUGE LABEL --- */
        .gauge-label-text {
            fill: var(--gauge-label-color);
            font-size: 18px;
            font-weight: bold;
            transition: fill 0.3s ease;
        }
        
        /* Theme Toggle Switch Styles */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 20px;
            width: 100%;
            max-width: 500px; 
        }
        .theme-switch { display: inline-block; height: 34px; position: relative; width: 60px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--toggle-bg); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: var(--toggle-fg); bottom: 4px; content: ""; height: 26px; left: 4px; position: absolute; transition: .4s; width: 26px; border-radius: 50%; content: '‚òÄÔ∏è'; display: flex; align-items: center; justify-content: center; font-size: 16px; color: var(--toggle-icon-color); }
        input:checked + .slider:before { transform: translateX(26px); content: 'üåô'; }

    </style>
</head>
<body>
    
    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
            <div class="slider round"></div>
        </label>
    </div>

    <div class="container">
        <div id="gauge-temp-container" class="gauge-container"></div>
        <div id="gauge-damper-container" class="gauge-container"></div>
    </div>

<script>
    require(['baja!', 'd3'], function (baja, d3) {
        'use strict';
        
        function createGauge(containerId, label, min, max) {
            var width = 200, height = 180, radius = 80, arcWidth = 25;

            var svg = d3.select(containerId)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + (height / 2 + 30) + ")");

            // --- MODIFIED: Assigns a class and removes inline styles ---
            var labelText = svg.append("text")
                .attr("class", "gauge-label-text") // Assign class
                .attr("text-anchor", "middle")
                .attr("y", 30)
                .text(label);

            var scale = d3.scale.linear().domain([min, max]).range([-Math.PI / 2, Math.PI / 2]).clamp(true);
            var arc = d3.svg.arc().innerRadius(radius - arcWidth).outerRadius(radius).startAngle(-Math.PI / 2);

            var background = svg.append("path").datum({endAngle: Math.PI / 2}).attr("d", arc);
            var foreground = svg.append("path").datum({endAngle: -Math.PI / 2}).attr("class", "gauge-foreground").attr("d", arc);
            var valueText = svg.append("text").attr("text-anchor", "middle").attr("dy", "0.3em").style("font-size", "30px").style("font-weight", "bold").text("...");

            function updateTheme() {
                var styles = getComputedStyle(document.documentElement);
                var bgColor = styles.getPropertyValue('--gauge-bg-arc-color');
                var valColor = styles.getPropertyValue('--gauge-value-color');

                // --- MODIFIED: No longer needs to set label color ---
                background.style("fill", bgColor);
                valueText.style("fill", valColor);
            }

            function update(valueDisplay) {
                var numericValue = parseFloat(valueDisplay);
                if (isNaN(numericValue)) { return; }
                valueText.text(valueDisplay);
                foreground.transition().duration(750)
                    .attrTween("d", function(d) {
                        var interpolate = d3.interpolate(d.endAngle, scale(numericValue));
                        return function(t) { d.endAngle = interpolate(t); return arc(d); };
                    });
            }
            
            updateTheme();
            return { update: update, updateTheme: updateTheme };
        }

        // --- Main Logic (No changes below this line) ---
        const gauges = [];
        const pointsToMonitor = [
            {
                id: 'SpaceTemp',
                ord: 'station:|slot:/VAV/SpaceTemp',
                gauge: createGauge('#gauge-temp-container', 'Space Temp', 60, 80)
            },
            {
                id: 'DamperCmd',
                ord: 'station:|slot:/VAV/DamperCmd',
                gauge: createGauge('#gauge-damper-container', 'Damper Position', 0, 100)
            }
        ];
        
        pointsToMonitor.forEach(p => gauges.push(p.gauge));
        const subscriber = new baja.Subscriber();
        const pointToGaugeMap = new Map();
        subscriber.attach('changed', function(prop) {
            if (prop.getName() === 'out') {
                const gaugeUpdater = pointToGaugeMap.get(this);
                if (gaugeUpdater) {
                    gaugeUpdater.update(this.getOut().getValueDisplay());
                }
            }
        });

        pointsToMonitor.forEach(config => {
            baja.Ord.make(config.ord).get({ subscriber: subscriber })
                .then(point => {
                    pointToGaugeMap.set(point, config.gauge);
                    config.gauge.update(point.getOut().getValueDisplay());
                })
                .catch(error => {
                    console.error("Failed to resolve ORD: " + config.ord, error);
                });
        });

        const toggle = document.getElementById('checkbox');
        
        function applyTheme(theme) {
            if (theme === 'dark-mode') {
                document.body.classList.add('dark-mode');
                toggle.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                toggle.checked = false;
            }
            gauges.forEach(gauge => gauge.updateTheme());
        }

        toggle.addEventListener('change', function() {
            const theme = this.checked ? 'dark-mode' : 'light-mode';
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        });

        const savedTheme = localStorage.getItem('theme') || 'light-mode';
        applyTheme(savedTheme);
    });
</script>

</body>
</html>